<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chauncy.data.mapper.product.PmGoodsMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.chauncy.data.domain.po.product.PmGoodsPo">
        <id column="id" property="id"/>
        <result column="goods_category_id" property="goodsCategoryId"/>
        <result column="name" property="name"/>
        <result column="subtitle" property="subtitle"/>
        <result column="icon" property="icon"/>
        <result column="carousel_image" property="carouselImage"/>
        <result column="detail_html" property="detailHtml"/>
        <result column="shipping_template_id" property="shippingTemplateId"/>
        <result column="location" property="location"/>
        <result column="purchase_limit" property="purchaseLimit"/>
        <result column="is_tax" property="isTax"/>
        <result column="activity_cost_rate" property="activityCostRate"/>
        <result column="profits_rate" property="profitsRate"/>
        <result column="generalize_cost_rate" property="generalizeCostRate"/>
        <result column="tax_rate_type" property="taxRateType"/>
        <result column="custom_tax_rate" property="customTaxRate"/>
        <result column="sort" property="sort"/>
        <result column="is_free_postage" property="isFreePostage"/>
        <result column="stock" property="stock"/>
        <result column="low_stock" property="lowStock"/>
        <result column="publish_status" property="publishStatus"/>
        <result column="new_status" property="newStatus"/>
        <result column="recommand_status" property="recommandStatus"/>
        <result column="star_status" property="starStatus"/>
        <result column="verify_status" property="verifyStatus"/>
        <result column="store_id" property="storeId"/>
        <result column="goods_type" property="goodsType"/>
        <result column="spu" property="spu"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>
        <result column="content" property="content"/>
        <result column="is_excel" property="isExcel"/>
        <result column="sales_volume" property="salesVolume"/>
    </resultMap>

    <update id="updateStock">
        update pm_goods set stock=stock+#{number} where id=#{goodId}
    </update>

    <select id="findGoodsValue" resultType="com.chauncy.data.bo.supplier.good.GoodsValueBo">
        select b.id,b.value as name,b.is_custom
        from pm_goods_rel_attribute_value_sku a ,pm_goods_attribute_value b, pm_goods_attribute c,pm_goods_sku d
        <where>
            a.goods_attribute_value_id = b.id and b.product_attribute_id = c.id and a.del_flag = 0
            and d.id = a.goods_sku_id
            <if test="attributeId !=null">
                and c.id = #{attributeId}
            </if>
            <if test="goodsId !=null">
                and d.goods_id=#{goodsId}
            </if>
        </where>
        GROUP BY b.id
    </select>

    <select id="searchGoodsInfo" resultType="com.chauncy.data.vo.supplier.PmGoodsVo">
        SELECT a.id,a.icon,a.NAME as good_name,a.sort,a.sales_volume,a.star_status,a.publish_status,a.verify_status,
        Min(b.supplier_price) AS supplier_price, Min(b.sell_price) AS sell_price,d.name as brandName
        from pm_goods a
        LEFT JOIN pm_goods_sku b on a.id = b.goods_id and b.del_flag = 0
        LEFT JOIN pm_goods_rel_attribute_good c on c.del_flag = 0 and c.goods_good_id = a.id
        inner JOIN pm_goods_attribute d on c.goods_attribute_id = d.id and d.type=8
        inner join pm_goods_category e on e.id = a.goods_category_id
        left join sm_store f on f.id = a.store_id and f.del_flag = 0
        <where>
         <if test="goodName!=null and goodName !=''">
             and a.name like concat('%', #{goodName}, '%')
         </if>
         <if test="categoryName!=null and categoryName!=''">
             and e.name like concat('%', #{categoryName}, '%')
         </if>
         <if test="brandName !=null and brandName!=''">
            and d.name like concat('%', #{brandName}, '%')
         </if>
         <if test="verifyStatus!=null">
            and a.verify_status = #{verifyStatus}
         </if>
         <if test="publishStatus!=null">
            and a.publish_status=#{publishStatus}
         </if>
         <if test="storeName!=null and storeName!=''">
            and f.name like concat('%', #{storeName}, '%')
         </if>
            <if test="lowestSellPrice!=null">
                and b.sell_price &gt;=lowestSellPrice
            </if>
            <if test="highestSellPrice!=null">
                and b.sell_price &lt;=highestSellPrice
            </if>
            <if test="lowestSupplierPrice!=null">
                and b.supplier_price &gt;=lowestSupplierPrice
            </if>
            <if test="highestSupplierPrice!=null">
                and b.supplier_price &lt;=highestSupplierPrice
            </if>
        </where>
        GROUP BY a.id,d.id order by a.sort;
    </select>


    <select id="searchRelGoodsByInfoId" resultType="com.chauncy.data.vo.supplier.InformationRelGoodsVo">
    SELECT mrig.id, pg.`name`, pg.goods_category_id, Min(pgs.sell_price) AS sell_price,pg.goods_type
    FROM mm_information_rel_goods mrig
         LEFT JOIN pm_goods pg on (pg.id = mrig.goods_id and pg.del_flag = 0)
         LEFT JOIN pm_goods_sku pgs on (pg.id = pgs.goods_id and pgs.del_flag = 0)
    <where>
         mrig.information_id = #{id}
    </where>
    GROUP BY pg.id
    </select>

    <select id="searchExcelGoods" resultType="com.chauncy.data.vo.supplier.good.ExcelGoodVo">
        select id,name,create_time import_time
        from pm_goods where is_excel=true
        and del_flag=0
        <if test="id!=null and id!=0">
            and id=#{id}
        </if>
        <if test="name!=null and name!=''">
            and name like concat('%', #{name}, '%')
        </if>

    </select>


</mapper>
